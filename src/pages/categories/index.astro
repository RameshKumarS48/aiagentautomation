---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { slugify } from '../../utils/slugify';

const agents = await getCollection('agents');

// Group by category
const categoryMap = new Map<string, typeof agents>();
agents.forEach(agent => {
  const cat = agent.data.category;
  if (!categoryMap.has(cat)) {
    categoryMap.set(cat, []);
  }
  categoryMap.get(cat)!.push(agent);
});

// Filter out malformed categories and sort by count
const categories = Array.from(categoryMap.entries())
  .filter(([name]) => !name.includes('[') && !name.includes('('))
  .sort((a, b) => b[1].length - a[1].length);
---

<BaseLayout
  title="AI Agent Categories"
  description="Browse AI agents by category. Find the right automation tool for your specific use case."
>
  <section class="pt-28 pb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="font-display text-4xl font-bold text-text-primary mb-4">Categories</h1>
      <p class="text-text-secondary text-lg">
        {categories.length} categories, {agents.length} total agents
      </p>
    </div>
  </section>

  <section class="py-8 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {categories.map(([category, categoryAgents]) => (
          <a href={`/categories/${slugify(category)}/`}
             class="card group cursor-pointer">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-accent flex items-center justify-center
                          transition-transform duration-300 group-hover:scale-110">
                <span class="text-white font-bold text-lg">{category.charAt(0)}</span>
              </div>
              <span class="text-3xl font-display font-bold text-text-muted group-hover:text-accent-blue transition-colors">
                {categoryAgents.length}
              </span>
            </div>
            <h2 class="font-display text-xl font-semibold text-text-primary mb-2 group-hover:text-accent-blue transition-colors">
              {category}
            </h2>
            <p class="text-text-secondary text-sm">
              {categoryAgents.slice(0, 3).map(a => a.data.name).join(', ')}
              {categoryAgents.length > 3 && ` +${categoryAgents.length - 3} more`}
            </p>
          </a>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
