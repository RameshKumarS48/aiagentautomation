---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blogs');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get related posts
const allPosts = await getCollection('blogs');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === post.data.category)
  .slice(0, 3);

// Get related agents if any
const allAgents = await getCollection('agents');
const relatedAgents = post.data.related_agents
  ? allAgents.filter(agent => post.data.related_agents?.includes(agent.slug)).slice(0, 4)
  : [];

const publishDate = new Date(post.data.published_date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout
  title={post.data.title}
  description={post.data.excerpt}
>
  <article class="pt-28 pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8">
        <a href="/" class="hover:text-accent-blue transition-colors">Home</a>
        <span>/</span>
        <a href="/blog/" class="hover:text-accent-blue transition-colors">Blog</a>
        <span>/</span>
        <span class="text-text-secondary truncate">{post.data.title}</span>
      </nav>

      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-center gap-3 mb-4">
          <a href={`/blog/category/${post.data.category.toLowerCase().replace(/\s+/g, '-')}/`}
             class="px-3 py-1 rounded-full bg-accent-blue/20 text-accent-blue text-sm font-medium hover:bg-accent-blue/30 transition-colors">
            {post.data.category}
          </a>
          <span class="text-text-muted text-sm">{post.data.read_time} min read</span>
        </div>

        <h1 class="font-display text-3xl md:text-4xl font-bold text-text-primary mb-4">
          {post.data.title}
        </h1>

        <p class="text-text-secondary text-lg mb-6">{post.data.excerpt}</p>

        <div class="flex items-center gap-4 text-sm text-text-muted">
          <span>By {post.data.author}</span>
          <span>|</span>
          <time datetime={post.data.published_date.toISOString()}>{publishDate}</time>
        </div>
      </header>

      <!-- Featured Image -->
      {post.data.image && (
        <div class="aspect-video rounded-2xl overflow-hidden mb-10 bg-dark-card">
          <img src={post.data.image} alt={post.data.image_alt || post.data.title}
               class="w-full h-full object-cover" />
        </div>
      )}

      <!-- Content -->
      <div class="prose prose-invert prose-lg max-w-none
                  prose-headings:font-display prose-headings:text-text-primary
                  prose-p:text-text-secondary prose-p:leading-relaxed
                  prose-a:text-accent-blue prose-a:no-underline hover:prose-a:underline
                  prose-strong:text-text-primary
                  prose-code:text-accent-cyan prose-code:bg-dark-card prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
                  prose-pre:bg-dark-card prose-pre:border prose-pre:border-dark-border
                  prose-blockquote:border-accent-blue prose-blockquote:bg-dark-card/50 prose-blockquote:rounded-r-xl
                  prose-li:text-text-secondary
                  prose-img:rounded-xl">
        <Content />
      </div>

      <!-- Tags -->
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="mt-10 pt-8 border-t border-dark-border">
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map(tag => (
              <a href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}/`}
                 class="px-3 py-1 rounded-full bg-dark-card border border-dark-border text-text-secondary text-sm
                        hover:border-accent-blue/50 hover:text-text-primary transition-all">
                #{tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Related Agents -->
      {relatedAgents.length > 0 && (
        <div class="mt-12 p-6 bg-dark-card border border-dark-border rounded-2xl">
          <h3 class="font-display text-lg font-semibold text-text-primary mb-4">Related AI Agents</h3>
          <div class="grid sm:grid-cols-2 gap-4">
            {relatedAgents.map(agent => (
              <a href={`/agents/${agent.slug}/`}
                 class="flex items-center gap-3 p-3 rounded-xl bg-dark-bg hover:bg-dark-border/50 transition-colors">
                <div class="w-10 h-10 rounded-lg bg-gradient-accent flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <span class="font-medium text-text-primary">{agent.data.name}</span>
                  <span class="block text-xs text-text-muted">{agent.data.category}</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Related Posts -->
      {relatedPosts.length > 0 && (
        <div class="mt-12">
          <h3 class="font-display text-xl font-semibold text-text-primary mb-6">Related Articles</h3>
          <div class="grid md:grid-cols-3 gap-6">
            {relatedPosts.map(relPost => (
              <a href={`/blog/${relPost.slug}/`} class="card group hover:border-accent-blue/50 transition-all">
                {relPost.data.image && (
                  <div class="aspect-video rounded-lg overflow-hidden mb-3 bg-dark-border">
                    <img src={relPost.data.image} alt={relPost.data.title}
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                         loading="lazy" />
                  </div>
                )}
                <h4 class="font-medium text-text-primary group-hover:text-accent-blue transition-colors line-clamp-2">
                  {relPost.data.title}
                </h4>
                <span class="text-text-muted text-xs mt-2 block">{relPost.data.read_time} min read</span>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
